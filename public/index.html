<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Translator â€“ Mic Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin: 2rem; }
    button { margin-right: .5rem; padding: .5rem 1rem; }
    .log { white-space: pre-wrap; background: #f7f7f7; padding: .75rem; border-radius: .5rem; }
  </style>
</head>
<body>
  <h1>EN â†’ (ASR stub) â€“ Mic Capture</h1>
  <p>Record, playback, then send audio to <code>/api/asr/en</code>. For now this returns a dummy transcript.</p>

  <div>
    <button id="btnStart">ğŸ™ï¸ Start</button>
    <button id="btnStop" disabled>â¹ï¸ Stop</button>
    <button id="btnSend" disabled>ğŸ“¤ Send to /api/asr/en</button>
  </div>

  <h3>Playback</h3>
  <audio id="player" controls></audio>

  <h3>Response</h3>
  <div id="out" class="log"></div>

  <script>
    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const btnSend  = document.getElementById('btnSend');
    const player   = document.getElementById('player');
    const out      = document.getElementById('out');

    let mediaRecorder, chunks = [], lastBlob = null;
    const API_BASE = location.origin; // same origin as the page

    btnStart.onclick = async () => {
      chunks = []; lastBlob = null;
      out.textContent = 'Requesting micâ€¦';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? 'audio/webm;codecs=opus' : 'audio/webm';
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.onstop = () => {
          lastBlob = new Blob(chunks, { type: mimeType });
          player.src = URL.createObjectURL(lastBlob);
          btnSend.disabled = false;
          out.textContent = `Recorded ${Math.round(lastBlob.size/1024)} KB (${mimeType}). Ready to send.`;
        };
        mediaRecorder.start();
        btnStart.disabled = true; btnStop.disabled = false; btnSend.disabled = true;
        out.textContent = 'Recordingâ€¦';
      } catch (err) { out.textContent = 'Mic error: ' + err; }
    };

    btnStop.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        btnStart.disabled = false; btnStop.disabled = true;
      }
    };

    btnSend.onclick = async () => {
      if (!lastBlob) { out.textContent = 'No audio recorded.'; return; }
      out.textContent = 'Uploadingâ€¦';
      try {
        const res = await fetch(`${API_BASE}/api/asr/en`, {
          method: 'POST',
          headers: { 'Content-Type': lastBlob.type || 'application/octet-stream' },
          body: lastBlob
        });
        const json = await res.json();
        out.textContent = JSON.stringify(json, null, 2);
      } catch (err) {
        out.textContent = 'Upload error: ' + err;
      }
    };
  </script>
</body>
</html>